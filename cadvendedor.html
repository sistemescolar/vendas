<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Prestação de Contas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: #f9f9f9;
    }

    h2, h3 {
      color: #333;
    }

    .form-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      width: 75¢;
    }

    input {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 180px;
    }

    button {
      padding: 8px 16px;
      background-color: #28a745;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    ul {
      padding-left: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    .vendedor {
      cursor: pointer;
      color: blue;
      text-decoration: underline;
    }

    .botoes-vendedor {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h2>Cadastro de Vendedores</h2>

  <div class="form-group">
    <input id="nome" type="text" placeholder="Nome">
    <input id="localidade" type="text" placeholder="Localidade">
    <input id="cotacao" type="number" step="0.01" placeholder="Cotação (R$)">
    <button onclick="salvarVendedor()">Salvar</button>
  </div>

  <h3>Vendedores Cadastrados</h3>
  <ul id="listaVendedores"></ul>

  <div id="detalhesVendedor" style="margin-top: 30px;"></div>

  <script>
    let vendedores = JSON.parse(localStorage.getItem('vendedores')) || [];

    function salvarLocalStorage() {
      localStorage.setItem('vendedores', JSON.stringify(vendedores));
    }

    function salvarVendedor() {
      const nome = document.getElementById('nome').value.trim();
      const localidade = document.getElementById('localidade').value.trim();
      const cotacao = parseFloat(document.getElementById('cotacao').value);

      if (!nome || !localidade || isNaN(cotacao)) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      const vendedor = { nome, localidade, cotacao, historico: [] };
      vendedores.push(vendedor);
      salvarLocalStorage();
      atualizarLista();
      limparCampos();
    }

    function atualizarLista() {
      const lista = document.getElementById('listaVendedores');
      lista.innerHTML = '';
      vendedores.forEach((v, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="vendedor" onclick="mostrarDetalhes(${i})">${v.nome}</span>
          <button onclick="editarVendedor(${i})" style="margin-left: 10px;">Editar</button>
        `;
        lista.appendChild(li);
      });
    }

    function limparCampos() {
      document.getElementById('nome').value = '';
      document.getElementById('localidade').value = '';
      document.getElementById('cotacao').value = '';
    }

    function calcularTotais(vendedor) {
      return vendedor.historico.map((linha) => {
        const vendeu = linha.recebeu - linha.devolveu;
        const apurou = vendeu * vendedor.cotacao;
        const deve = apurou - linha.pagou;
        return { ...linha, vendeu, apurou, deve };
      });
    }

    function mostrarDetalhes(index) {
      const vendedor = vendedores[index];
      const historicoCalculado = calcularTotais(vendedor);

      const totalApurado = historicoCalculado.reduce((s, h) => s + h.apurou, 0);
      const totalPago = historicoCalculado.reduce((s, h) => s + h.pagou, 0);
      const totalDevedor = totalApurado - totalPago;

      const div = document.getElementById('detalhesVendedor');
      div.innerHTML = `
        <h3>Detalhes do Vendedor</h3>
        <p><strong>Nome:</strong> ${vendedor.nome}</p>
        <p><strong>Localidade:</strong> ${vendedor.localidade}</p>
        <p><strong>Total Apurado:</strong> R$ ${totalApurado.toFixed(2)}</p>
        <p><strong>Total Pago:</strong> R$ ${totalPago.toFixed(2)}</p>
        <p><strong>Total Devedor:</strong> R$ ${totalDevedor.toFixed(2)}</p>
        <table>
          <thead>
            <tr>
              <th>Data</th><th>Recebeu</th><th>Devolveu</th><th>Vendeu</th>
              <th>Apurou</th><th>Pagou</th><th>Deve</th><th>Situação</th><th>Ações</th>
            </tr>
          </thead>
          <tbody id="historicoTabela"></tbody>
        </table>
        <div class="botoes-vendedor">
          <button onclick="adicionarLinha(${index})">Adicionar Linha</button>
          <button onclick="exportarPDF(${index})">Exportar PDF</button>
        </div>
      `;
      atualizarTabela(index, historicoCalculado);
    }

    function atualizarTabela(index, historicoCalculado) {
      const tabela = document.getElementById('historicoTabela');
      tabela.innerHTML = '';
      historicoCalculado.forEach((linha, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${linha.data}</td>
          <td>${linha.recebeu}</td>
          <td>${linha.devolveu}</td>
          <td>${linha.vendeu}</td>
          <td>R$ ${linha.apurou.toFixed(2)}</td>
          <td>R$ ${linha.pagou.toFixed(2)}</td>
          <td>R$ ${linha.deve.toFixed(2)}</td>
          <td>${linha.situacao}</td>
          <td><button onclick="editarLinha(${index}, ${i})">Editar</button></td>
        `;
        tabela.appendChild(tr);
      });
    }

    function adicionarLinha(index) {
      const data = prompt("Data:");
      const recebeu = parseInt(prompt("Quantidade Recebida:"));
      const devolveu = parseInt(prompt("Quantidade Devolvida:"));
      const pagou = parseFloat(prompt("Valor Pago:"));
      const situacao = prompt("Situação:");

      if (!data || isNaN(recebeu) || isNaN(devolveu) || isNaN(pagou)) {
        alert('Preencha corretamente os dados.');
        return;
      }

      const linha = { data, recebeu, devolveu, pagou, situacao };
      vendedores[index].historico.push(linha);
      salvarLocalStorage();
      mostrarDetalhes(index);
    }

    function editarLinha(vIndex, hIndex) {
      const h = vendedores[vIndex].historico[hIndex];
      h.data = prompt("Data:", h.data);
      h.recebeu = parseInt(prompt("Recebeu:", h.recebeu));
      h.devolveu = parseInt(prompt("Devolveu:", h.devolveu));
      h.pagou = parseFloat(prompt("Pagou:", h.pagou));
      h.situacao = prompt("Situação:", h.situacao);
      salvarLocalStorage();
      mostrarDetalhes(vIndex);
    }

    function editarVendedor(index) {
      const vendedor = vendedores[index];
      const nome = prompt("Nome:", vendedor.nome);
      const localidade = prompt("Localidade:", vendedor.localidade);
      const cotacao = parseFloat(prompt("Cotação:", vendedor.cotacao));

      if (!nome || !localidade || isNaN(cotacao)) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      vendedor.nome = nome;
      vendedor.localidade = localidade;
      vendedor.cotacao = cotacao;
      salvarLocalStorage();
      atualizarLista();
      mostrarDetalhes(index);
    }

    async function exportarPDF(index) {
      const { jsPDF } = window.jspdf;
      const vendedor = vendedores[index];
      const historico = calcularTotais(vendedor);

      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text(`Histórico de Vendas - ${vendedor.nome}`, 15, 15);

      const headers = [["Data", "Recebeu", "Devolveu", "Vendeu", "Apurou", "Pagou", "Deve", "Situação"]];
      const data = historico.map(h => [
        h.data,
        h.recebeu,
        h.devolveu,
        h.vendeu,
        `R$ ${h.apurou.toFixed(2)}`,
        `R$ ${h.pagou.toFixed(2)}`,
        `R$ ${h.deve.toFixed(2)}`,
        h.situacao
      ]);

      doc.autoTable({
        head: headers,
        body: data,
        startY: 25,
        styles: { fontSize: 10 }
      });

      doc.save(`historico_${vendedor.nome.replace(/\s+/g, "_")}.pdf`);
    }

    atualizarLista();
if (localStorage.getItem('logado') !== 'true') {
  window.location.href = 'index.html';
}

  </script>

</body>
</html>
